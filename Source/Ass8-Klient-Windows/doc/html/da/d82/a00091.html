<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Ass8-Klient: Plik źródłowy komunikacja.cs</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css">
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Wygenerowano przez Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../main.html"><span>Strona&nbsp;główna</span></a></li>
      <li><a href="../../namespaces.html"><span>Pakiety</span></a></li>
      <li><a href="../../annotated.html"><span>Klasy</span></a></li>
      <li class="current"><a href="../../files.html"><span>Pliki</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>Lista&nbsp;plików</span></a></li>
      <li><a href="../../globals.html"><span>Składowe&nbsp;plików</span></a></li>
    </ul>
  </div>
<h1>komunikacja.cs</h1><a href="../../d2/dee/a00049.html">Idź do dokumentacji tego pliku.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../d2/dee/a00049.html#81a223a02c34d82b47199f08308847f2">00001</a> ﻿using <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>;
<a name="l00002"></a>00002 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Collections.Generic;
<a name="l00003"></a>00003 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Text;
<a name="l00004"></a>00004 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Xml;
<a name="l00005"></a>00005 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.IO;
<a name="l00006"></a>00006 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Net;
<a name="l00007"></a>00007 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Net.Sockets;
<a name="l00008"></a>00008 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Xml.Serialization;
<a name="l00009"></a>00009 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Windows.Forms;
<a name="l00010"></a>00010 <span class="keyword">using</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Security.Cryptography;
<a name="l00011"></a>00011 <span class="keyword">using</span> GlacialComponents.Controls;
<a name="l00012"></a>00012 <span class="keyword">namespace </span>ASS8.<a class="code" href="../../d3/de7/a00039.html#50d8d80fabd02a9a24fb725624e1ad24">Klient</a>
<a name="l00013"></a>00013 {
<a name="l00014"></a><a class="code" href="../../d7/dd4/a00013.html">00014</a>     <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="../../d7/dd4/a00013.html">komunikacja</a>
<a name="l00015"></a>00015     {
<a name="l00019"></a><a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2">00019</a>         <span class="keyword">private</span> <span class="keyword">enum</span> <a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>
<a name="l00020"></a>00020         {
<a name="l00021"></a>00021             lista = 100, pobieranie, wysylanie, usuwanie
<a name="l00022"></a>00022         }
<a name="l00023"></a><a class="code" href="../../d7/dd4/a00013.html#2c01e8a98bfa8f0404b94af607eacbba">00023</a>         <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> endl = <span class="stringliteral">"\r\n\r\n"</span>;
<a name="l00024"></a><a class="code" href="../../d7/dd4/a00013.html#50e87371e5422a5bc0cb7b81a917e569">00024</a>         <span class="keyword">private</span> <span class="keyword">const</span> <span class="keywordtype">string</span> endlOdp = <span class="stringliteral">"#"</span>;
<a name="l00025"></a><a class="code" href="../../d7/dd4/a00013.html#d521d29af9bd410a982fb72814ae1eb0">00025</a>         Socket socket;
<a name="l00031"></a><a class="code" href="../../d7/dd4/a00013.html#5069ee8ced0e023865e277f07ba690a9">00031</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> wyslij(byte[] wiadomosc, <span class="keywordtype">int</span> dlugosc)
<a name="l00032"></a>00032         {
<a name="l00033"></a>00033 
<a name="l00034"></a>00034             <span class="keywordflow">try</span>
<a name="l00035"></a>00035             {
<a name="l00036"></a>00036                 socket.Send(wiadomosc);
<a name="l00037"></a>00037             }
<a name="l00038"></a>00038             <span class="keywordflow">catch</span> (Exception ex)
<a name="l00039"></a>00039             {
<a name="l00040"></a>00040                 MessageBox.Show(ex.ToString());
<a name="l00041"></a>00041             }
<a name="l00042"></a>00042         }
<a name="l00049"></a><a class="code" href="../../d7/dd4/a00013.html#19e1f9dd822287532839c60661237142">00049</a>         <span class="keyword">private</span> <span class="keywordtype">int</span> pobierz(<span class="keywordtype">int</span> dlugosc, out byte[] bytes)
<a name="l00050"></a>00050         {
<a name="l00051"></a>00051             bytes = <span class="keyword">new</span> byte[dlugosc];
<a name="l00052"></a>00052             <span class="keywordtype">int</span> i = 0;
<a name="l00053"></a>00053             <span class="keywordflow">try</span>
<a name="l00054"></a>00054             {
<a name="l00055"></a>00055                 i = socket.Receive(bytes, 0, dlugosc, SocketFlags.None);
<a name="l00056"></a>00056             }
<a name="l00057"></a>00057             <span class="keywordflow">catch</span> (Exception)
<a name="l00058"></a>00058             {
<a name="l00059"></a>00059                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas odbierania"</span>);
<a name="l00060"></a>00060             }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062             <span class="keywordflow">return</span> i;
<a name="l00063"></a>00063         }
<a name="l00068"></a><a class="code" href="../../d7/dd4/a00013.html#1b3c9442d102dd6e6b4d64cb0c31b660">00068</a>         <span class="keyword">private</span> <span class="keywordtype">string</span> pobierz()
<a name="l00069"></a>00069         {
<a name="l00070"></a>00070             <span class="keywordtype">int</span> dlugoscOdp = 0;
<a name="l00071"></a>00071             StringBuilder strRead = <span class="keyword">new</span> StringBuilder();
<a name="l00072"></a>00072             <span class="keywordflow">while</span> (<span class="keyword">true</span>)
<a name="l00073"></a>00073             {
<a name="l00074"></a>00074                 byte[] buffer = <span class="keyword">new</span> byte[1024];
<a name="l00075"></a>00075                 <span class="keywordtype">int</span> rx = socket.Receive(buffer, 0, 1, SocketFlags.None);
<a name="l00076"></a>00076                 dlugoscOdp += rx;
<a name="l00077"></a>00077                 strRead.Append(Encoding.ASCII.GetString(buffer).Substring(0, rx));
<a name="l00078"></a>00078                 <span class="keywordflow">if</span> (dlugoscOdp &gt;= 2)
<a name="l00079"></a>00079                     <span class="keywordflow">if</span> (strRead.ToString().Substring(strRead.Length - endlOdp.Length, endlOdp.Length).CompareTo(endlOdp) == 0) <span class="keywordflow">break</span>;
<a name="l00080"></a>00080             }
<a name="l00081"></a>00081             <span class="keywordflow">return</span> strRead.ToString().Substring(0, strRead.Length - endlOdp.Length);
<a name="l00082"></a>00082         }
<a name="l00086"></a><a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9">00086</a>         <span class="keyword">private</span> <span class="keyword">enum</span> <a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>
<a name="l00087"></a>00087         {
<a name="l00088"></a>00088             bledne_zapytanie = 400, bledny_numer_sesji, plik_istnieje, blad_serwera, plik_nie_istnieje, blad_odbierania_plikow, wszystko_ok
<a name="l00089"></a>00089         }
<a name="l00090"></a><a class="code" href="../../d7/dd4/a00013.html#1a50c04cee4acf979e3be6b7eeb41843">00090</a>         <span class="keyword">public</span> <span class="keywordtype">string</span> folder;
<a name="l00091"></a><a class="code" href="../../d7/dd4/a00013.html#fad59850af421f7d3a2ad72f29fabe3d">00091</a>         XmlSerializerNamespaces names;
<a name="l00092"></a><a class="code" href="../../d7/dd4/a00013.html#b992298af41161b42d77dbf23dfccad8">00092</a>         <span class="keyword">private</span> <span class="keywordtype">int</span> sessionID;
<a name="l00093"></a><a class="code" href="../../d7/dd4/a00013.html#596f53c293d3811c950901c69c30aee4">00093</a>         <span class="keyword">private</span> String serverIP;
<a name="l00094"></a><a class="code" href="../../d7/dd4/a00013.html#6b37a2dd270fa5483aad7080a7ff71d4">00094</a>         <span class="keyword">private</span> <span class="keywordtype">int</span> serverPort;
<a name="l00095"></a><a class="code" href="../../d7/dd4/a00013.html#4b00947de0ccf2197483dd77d35538f5">00095</a>         <span class="keyword">private</span> <span class="keywordtype">string</span> log;
<a name="l00096"></a><a class="code" href="../../d7/dd4/a00013.html#3003b01b9def7b324ad146f5598b00f1">00096</a>         <span class="keyword">private</span> <span class="keywordtype">string</span> haslo;
<a name="l00102"></a><a class="code" href="../../d7/dd4/a00013.html#da808f405d71a8f5f06659bac3b3fe50">00102</a>         <span class="keyword">public</span> <span class="keywordtype">void</span> ustawUstawienia(<span class="keywordtype">string</span> s, <span class="keywordtype">int</span> p)
<a name="l00103"></a>00103         {
<a name="l00104"></a>00104             serverIP = s;
<a name="l00105"></a>00105             serverPort = p;
<a name="l00106"></a>00106         }
<a name="l00110"></a><a class="code" href="../../d7/dd4/a00013.html#178f432b69d8d6f2c1d6b8f6d1c43eb9">00110</a>         <span class="keyword">public</span> <a class="code" href="../../d7/dd4/a00013.html">komunikacja</a>()
<a name="l00111"></a>00111         {
<a name="l00112"></a>00112             names = <span class="keyword">new</span> XmlSerializerNamespaces();
<a name="l00113"></a>00113             names.Add(<span class="stringliteral">""</span>, <span class="stringliteral">""</span>);
<a name="l00114"></a>00114             log = <span class="stringliteral">""</span>;
<a name="l00115"></a>00115             haslo = <span class="stringliteral">""</span>;
<a name="l00116"></a>00116         }
<a name="l00121"></a><a class="code" href="../../d7/dd4/a00013.html#cdc8379f1139bc25fb24a6c9b6ce1cc1">00121</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> login()
<a name="l00122"></a>00122         {
<a name="l00123"></a>00123             <span class="keywordflow">if</span> (log == <span class="stringliteral">""</span> || haslo == <span class="stringliteral">""</span>) <span class="keywordflow">return</span> -2;
<a name="l00124"></a>00124             <span class="keywordflow">try</span>
<a name="l00125"></a>00125             {
<a name="l00126"></a>00126                 socket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.IP);
<a name="l00127"></a>00127                 IPAddress remoteIPAddress = <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Net.IPAddress.Parse(serverIP);
<a name="l00128"></a>00128                 IPEndPoint remoteEndPoint = <span class="keyword">new</span> <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Net.IPEndPoint(remoteIPAddress, serverPort);
<a name="l00129"></a>00129                 socket.Connect(remoteEndPoint);
<a name="l00130"></a>00130             }
<a name="l00131"></a>00131             <span class="keywordflow">catch</span> (Exception)
<a name="l00132"></a>00132             {
<a name="l00133"></a>00133                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladPolaczenia(<span class="stringliteral">"Blad podczas laczenia do serwera. Sprawdz adres oraz port"</span>);
<a name="l00134"></a>00134             }
<a name="l00135"></a>00135             <span class="keywordflow">try</span>
<a name="l00136"></a>00136             {
<a name="l00137"></a>00137                 StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00138"></a>00138                 <a class="code" href="../../da/da0/a00009.html" title="Klasa zawiera dane do serializacji zapytania o logowanie.">klientLogowanie</a> logowanie = <span class="keyword">new</span> <a class="code" href="../../da/da0/a00009.html" title="Klasa zawiera dane do serializacji zapytania o logowanie.">klientLogowanie</a>(log, haslo, <a class="code" href="../../d8/d84/a00001.html" title="Kalsa odpowiedzialna za wyswietlenie okna i zalogowanie uzytkownika.">ASS8___Logowanie</a>.wersja);
<a name="l00139"></a>00139                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../da/da0/a00009.html" title="Klasa zawiera dane do serializacji zapytania o logowanie.">klientLogowanie</a>));
<a name="l00140"></a>00140                 xml.Serialize(stringWriter, logowanie, names);
<a name="l00141"></a>00141                 <span class="keywordtype">string</span> stR = stringWriter.ToString() + endl;
<a name="l00142"></a>00142                 wyslij(ASCIIEncoding.ASCII.GetBytes(stR), stR.Length);
<a name="l00143"></a>00143             }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145             <span class="keywordflow">catch</span> (Exception)
<a name="l00146"></a>00146             {
<a name="l00147"></a>00147                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania danych na serwer. Sprawdz polaczenie z internetem, oraz ewentualnie ustaw proxy -- zapytanie o logowanie"</span>);
<a name="l00148"></a>00148             }
<a name="l00149"></a>00149             <span class="keywordtype">string</span> str;
<a name="l00150"></a>00150             <span class="keywordflow">try</span>
<a name="l00151"></a>00151             {
<a name="l00152"></a>00152                 str = pobierz();
<a name="l00153"></a>00153             }
<a name="l00154"></a>00154             <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00155"></a>00155             {
<a name="l00156"></a>00156                 bo.add(<span class="stringliteral">"-- odpowiedz logowania"</span>);
<a name="l00157"></a>00157                 <span class="keywordflow">throw</span> bo;
<a name="l00158"></a>00158             }
<a name="l00159"></a>00159             <span class="keywordflow">catch</span> (Exception)
<a name="l00160"></a>00160             {
<a name="l00161"></a>00161                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladNieokreslony(<span class="stringliteral">"Nieokreslony blad programu -- odpowiedz logowania"</span>);
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163             <a class="code" href="../../d3/dfe/a00025.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o logowanie.">serwerLogowanie</a> odpSerwera = <span class="keyword">new</span> <a class="code" href="../../d3/dfe/a00025.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o logowanie.">serwerLogowanie</a>();
<a name="l00164"></a>00164             <span class="keywordflow">try</span>
<a name="l00165"></a>00165             {
<a name="l00166"></a>00166                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d3/dfe/a00025.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o logowanie.">serwerLogowanie</a>));
<a name="l00167"></a>00167                 StringReader stringReader = <span class="keyword">new</span> StringReader(str);
<a name="l00168"></a>00168                 odpSerwera = (<a class="code" href="../../d3/dfe/a00025.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o logowanie.">serwerLogowanie</a>)xml.Deserialize(stringReader);
<a name="l00169"></a>00169             }
<a name="l00170"></a>00170             <span class="keywordflow">catch</span> (Exception)
<a name="l00171"></a>00171             {
<a name="l00172"></a>00172                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- deserializacja odpowiedzi o logowanie"</span>);
<a name="l00173"></a>00173             }
<a name="l00174"></a>00174             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/dfe/a00025.html#2db358a96d3e800ffda1100aefd4cb2f">odpowiedz</a> == 1)
<a name="l00175"></a>00175             {
<a name="l00176"></a>00176                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladNieokreslony(<span class="stringliteral">"Bledny login lub haslo"</span>);
<a name="l00177"></a>00177             }
<a name="l00178"></a>00178             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/dfe/a00025.html#2db358a96d3e800ffda1100aefd4cb2f">odpowiedz</a> == 0)
<a name="l00179"></a>00179                 sessionID = odpSerwera.<a class="code" href="../../d3/dfe/a00025.html#2102ee09e6fb509d2409223a6ce6e019">sesja</a>;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181             <span class="keywordflow">return</span> odpSerwera.<a class="code" href="../../d3/dfe/a00025.html#2db358a96d3e800ffda1100aefd4cb2f">odpowiedz</a>;
<a name="l00182"></a>00182         }
<a name="l00191"></a><a class="code" href="../../d7/dd4/a00013.html#d93f81514442cd3a5eeea0db9b1c9148">00191</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> downloadFiles(<span class="keywordtype">string</span>[] nazwyPlikow, <span class="keywordtype">string</span> uzytkownik, GLItem gli, <span class="keywordtype">string</span> path)
<a name="l00192"></a>00192         {
<a name="l00193"></a>00193             <span class="keywordflow">if</span> (uzytkownik.Length == 0) uzytkownik = <span class="stringliteral">"."</span>;
<a name="l00194"></a>00194             <span class="keywordflow">try</span>
<a name="l00195"></a>00195             {
<a name="l00196"></a>00196                 <a class="code" href="../../d7/d46/a00002.html" title="Klasa zawiera dane do serializacji zapytania o sciagniecie pliku.">downloadPliku</a> download = <span class="keyword">new</span> <a class="code" href="../../d7/d46/a00002.html" title="Klasa zawiera dane do serializacji zapytania o sciagniecie pliku.">downloadPliku</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.pobieranie, uzytkownik, nazwyPlikow);
<a name="l00197"></a>00197                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d7/d46/a00002.html" title="Klasa zawiera dane do serializacji zapytania o sciagniecie pliku.">downloadPliku</a>));
<a name="l00198"></a>00198                 StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00199"></a>00199                 xml.Serialize(stringWriter, download, names);
<a name="l00200"></a>00200                 <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00201"></a>00201                 wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203             <span class="keywordflow">catch</span> (Exception)
<a name="l00204"></a>00204             {
<a name="l00205"></a>00205                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania danych na serwer. Sprawdz polaczenie z internetem, oraz ewentualnie ustaw proxy -- zapytanie o sciagniecie plikow"</span>);
<a name="l00206"></a>00206             }
<a name="l00207"></a>00207             <span class="keywordflow">foreach</span> (<span class="keywordtype">string</span> s <span class="keywordflow">in</span> nazwyPlikow)
<a name="l00208"></a>00208             {
<a name="l00209"></a>00209                 <a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a> plikiNaSerwerze = <span class="keyword">new</span> <a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>();
<a name="l00210"></a>00210                 <span class="keywordtype">string</span>[] tab = s.Split(<span class="stringliteral">"/"</span>.ToCharArray());
<a name="l00211"></a>00211                 <span class="keywordtype">string</span> tmp = (folder[folder.Length-1]==<span class="charliteral">'/'</span>?folder:folder+<span class="stringliteral">"/"</span>);
<a name="l00212"></a>00212                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; tab.Length - 1; i++)
<a name="l00213"></a>00213                 {
<a name="l00214"></a>00214                     tmp += tab[i] + <span class="stringliteral">"/"</span>;
<a name="l00215"></a>00215                     <span class="keywordflow">if</span> (!Directory.Exists(tmp))
<a name="l00216"></a>00216                         Directory.CreateDirectory(tmp);
<a name="l00217"></a>00217                 }
<a name="l00218"></a>00218                 <span class="keywordflow">try</span>
<a name="l00219"></a>00219                 {
<a name="l00220"></a>00220                     XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>));
<a name="l00221"></a>00221                     <span class="keywordtype">string</span> str = pobierz();
<a name="l00222"></a>00222 
<a name="l00223"></a>00223                     StringReader stringReader = <span class="keyword">new</span> StringReader(str);
<a name="l00224"></a>00224                     plikiNaSerwerze = (<a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>)xml.Deserialize(stringReader);
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226                 <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00227"></a>00227                 {
<a name="l00228"></a>00228                     bo.add(<span class="stringliteral">"-- odpowiedz sciaganie plikow"</span>);
<a name="l00229"></a>00229                     <span class="keywordflow">throw</span> bo;
<a name="l00230"></a>00230                 }
<a name="l00231"></a>00231                 <span class="keywordflow">catch</span> (Exception)
<a name="l00232"></a>00232                 {
<a name="l00233"></a>00233                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- odpowiedz sciaganie plikow"</span>);
<a name="l00234"></a>00234                 }
<a name="l00235"></a>00235                 <span class="keywordflow">if</span> (plikiNaSerwerze.<a class="code" href="../../d3/d52/a00023.html#9e0414e76ae1f264010bd1dc1abbaef6">operacja</a> != (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.pobieranie) <span class="keywordflow">return</span> -3;
<a name="l00236"></a>00236                 <span class="keywordflow">if</span> (plikiNaSerwerze.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.wszystko_ok)
<a name="l00237"></a>00237                 {
<a name="l00238"></a>00238                     <span class="keywordflow">if</span> (plikiNaSerwerze.<a class="code" href="../../d6/d5b/a00026.html#b6d1b334712037271b25777240056f83">plik</a>.Count != 1)
<a name="l00239"></a>00239                     { 
<a name="l00240"></a>00240                         StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00241"></a>00241                         <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a> kod = <span class="keyword">new</span> <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.pobieranie, <span class="stringliteral">"ok"</span>);
<a name="l00242"></a>00242                         XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>));
<a name="l00243"></a>00243                         xml.Serialize(stringWriter, kod, names);
<a name="l00244"></a>00244                         <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00245"></a>00245                         wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00246"></a>00246                         StringReader stringReader = <span class="keyword">new</span> StringReader(<span class="stringliteral">""</span>);
<a name="l00247"></a>00247                         str = pobierz();
<a name="l00248"></a>00248                         XmlSerializer xmlO = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>));
<a name="l00249"></a>00249                         <a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a> odpSerwera = (<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>)xmlO.Deserialize(<span class="keyword">new</span> StringReader(str));
<a name="l00250"></a>00250                         <span class="keywordflow">continue</span>;
<a name="l00251"></a>00251                     }
<a name="l00252"></a>00252                     <a class="code" href="../../d1/d2b/a00018.html" title="Klasa zawiera dane do serializacji rozszerzonych informacji o pliku.">plikInfo</a> p = plikiNaSerwerze.<a class="code" href="../../d6/d5b/a00026.html#b6d1b334712037271b25777240056f83">plik</a>[0];
<a name="l00253"></a>00253                     <span class="keywordflow">if</span> (p.<a class="code" href="../../d1/d2b/a00018.html#e87d445327b832a69930c10f5555bf53">rozmiar</a> &gt;= 0)
<a name="l00254"></a>00254                     {
<a name="l00255"></a>00255                         FileStream streamWriter = null;
<a name="l00256"></a>00256                         <span class="keywordflow">if</span> (path == null)
<a name="l00257"></a>00257                             streamWriter = <span class="keyword">new</span> FileStream(folder + <span class="stringliteral">"/"</span> + p.<a class="code" href="../../d7/d7a/a00016.html#d79d58573126b1cd96f3c6966ae83434">nazwa</a>, FileMode.OpenOrCreate, FileAccess.Write);
<a name="l00258"></a>00258                         <span class="keywordflow">else</span>
<a name="l00259"></a>00259                         {
<a name="l00260"></a>00260                             <span class="keywordflow">if</span> (p.<a class="code" href="../../d1/d2b/a00018.html#e87d445327b832a69930c10f5555bf53">rozmiar</a> == 0)
<a name="l00261"></a>00261                                 ((ProgressBar)gli.SubItems[1].Control).PerformStep();
<a name="l00262"></a>00262                             streamWriter = <span class="keyword">new</span> FileStream(path + <span class="stringliteral">"/"</span> + p.<a class="code" href="../../d7/d7a/a00016.html#d79d58573126b1cd96f3c6966ae83434">nazwa</a>, FileMode.OpenOrCreate, FileAccess.Write);
<a name="l00263"></a>00263                         }
<a name="l00264"></a>00264                         <span class="keywordflow">try</span>
<a name="l00265"></a>00265                         {
<a name="l00266"></a>00266                             StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00267"></a>00267                             <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a> kod = <span class="keyword">new</span> <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.pobieranie, <span class="stringliteral">"ok"</span>);
<a name="l00268"></a>00268                             XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>));
<a name="l00269"></a>00269                             xml.Serialize(stringWriter, kod, names);
<a name="l00270"></a>00270                             <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00271"></a>00271                             wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00272"></a>00272                             <span class="keywordtype">int</span> rozmiar = p.<a class="code" href="../../d1/d2b/a00018.html#e87d445327b832a69930c10f5555bf53">rozmiar</a>;
<a name="l00273"></a>00273                             <span class="keywordtype">int</span> tempRozmiar = rozmiar;
<a name="l00274"></a>00274                             <span class="keywordflow">while</span> (tempRozmiar &gt; 0)
<a name="l00275"></a>00275                             {
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                                 <span class="keywordtype">int</span> readSize = 102400;
<a name="l00278"></a>00278                                 <span class="keywordflow">if</span> (tempRozmiar &lt; readSize)
<a name="l00279"></a>00279                                 {
<a name="l00280"></a>00280                                     readSize = tempRozmiar;
<a name="l00281"></a>00281                                 }
<a name="l00282"></a>00282                                 byte[] bytes;
<a name="l00283"></a>00283                                 <span class="keywordtype">int</span> odebrane = pobierz(readSize, out bytes);
<a name="l00284"></a>00284                                 tempRozmiar -= odebrane;
<a name="l00285"></a>00285                                 streamWriter.Write(bytes, 0, odebrane);
<a name="l00286"></a>00286                                 <span class="keywordflow">if</span> (gli != null)
<a name="l00287"></a>00287                                 {
<a name="l00288"></a>00288                                     ProgressBar pb = (ProgressBar)gli.SubItems[1].Control;
<a name="l00289"></a>00289                                     <span class="keywordtype">object</span>[] obj = <span class="keyword">new</span> <span class="keywordtype">object</span>[] { pb, odebrane };
<a name="l00290"></a>00290                                     postep(pb, odebrane);
<a name="l00291"></a>00291                                 }
<a name="l00292"></a>00292                             }
<a name="l00293"></a>00293                             streamWriter.Close();
<a name="l00294"></a>00294                         }
<a name="l00295"></a>00295                         <span class="keywordflow">catch</span> (Exception ex)
<a name="l00296"></a>00296                         {
<a name="l00297"></a>00297                             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania(<span class="stringliteral">"Wystapil Blad podczas odbierania pliku z serwera -- odbieranie pliku i zapisywanie"</span>);
<a name="l00298"></a>00298                         }
<a name="l00299"></a>00299                         <span class="keywordflow">finally</span>
<a name="l00300"></a>00300                         {
<a name="l00301"></a>00301                             streamWriter.Close();
<a name="l00302"></a>00302                         }
<a name="l00303"></a>00303                     }
<a name="l00304"></a>00304                 }
<a name="l00305"></a>00305             }
<a name="l00306"></a>00306             <span class="keywordflow">return</span> 1;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308         <span class="keyword">private</span> delegate <span class="keywordtype">void</span> ProgressBarHandler(ProgressBar bar, <span class="keywordtype">int</span> progressValue);
<a name="l00314"></a><a class="code" href="../../d7/dd4/a00013.html#2ff0f54013633857e608e3020ed82f70">00314</a>         <span class="keyword">private</span> <span class="keywordtype">void</span> postep(ProgressBar bar, <span class="keywordtype">int</span> progressValue)
<a name="l00315"></a>00315         {
<a name="l00316"></a>00316             <span class="comment">/*if (bar.InvokeRequired)</span>
<a name="l00317"></a>00317 <span class="comment">            {</span>
<a name="l00318"></a>00318 <span class="comment">                bar.Invoke(new ProgressBarHandler(postep), new object[] { progressValue });</span>
<a name="l00319"></a>00319 <span class="comment">            }</span>
<a name="l00320"></a>00320 <span class="comment">            else</span>
<a name="l00321"></a>00321 <span class="comment">            {</span>
<a name="l00322"></a>00322 <span class="comment">                bar.Value = progressValue;</span>
<a name="l00323"></a>00323 <span class="comment">            }*/</span>
<a name="l00324"></a>00324         }
<a name="l00332"></a><a class="code" href="../../d7/dd4/a00013.html#9449630c9b6bbf88144aba3981d8eb72">00332</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> uploadFile(<span class="keywordtype">string</span> nazwa, DateTime data, <span class="keywordtype">int</span> rozmiar)
<a name="l00333"></a>00333         {
<a name="l00334"></a>00334             <span class="keywordtype">string</span> katalog = ((folder[folder.Length - 1] == <span class="charliteral">'/'</span>) ? folder : folder + <span class="stringliteral">"/"</span>);
<a name="l00335"></a>00335             <span class="keywordflow">if</span> (!File.Exists(katalog + nazwa)) <span class="keywordflow">return</span> -4;
<a name="l00336"></a>00336             <span class="keywordflow">try</span>
<a name="l00337"></a>00337             {
<a name="l00338"></a>00338                 StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00339"></a>00339                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../da/d45/a00011.html" title="Klasa zawiera dane do serializacji zapytania o wysyłanie pliku.">klientUpload</a>));
<a name="l00340"></a>00340                 <a class="code" href="../../da/d45/a00011.html" title="Klasa zawiera dane do serializacji zapytania o wysyłanie pliku.">klientUpload</a> upload = <span class="keyword">new</span> <a class="code" href="../../da/d45/a00011.html" title="Klasa zawiera dane do serializacji zapytania o wysyłanie pliku.">klientUpload</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.wysylanie, nazwa, (<span class="keywordtype">long</span>)(data - <span class="keyword">new</span> DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds, rozmiar, 0, hashPliku(katalog + nazwa));
<a name="l00341"></a>00341                 xml.Serialize(stringWriter, upload, names);
<a name="l00342"></a>00342                 <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00343"></a>00343                 wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00344"></a>00344             }
<a name="l00345"></a>00345             <span class="keywordflow">catch</span> (Exception)
<a name="l00346"></a>00346             {
<a name="l00347"></a>00347                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania danych na serwer. Sprawdz polaczenie z internetem, oraz ewentualnie ustaw proxy -- wysylanie zapytanie"</span>);
<a name="l00348"></a>00348             }
<a name="l00349"></a>00349             <a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a> odpSerwera = <span class="keyword">new</span> <a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>();
<a name="l00350"></a>00350             <span class="keywordflow">try</span>
<a name="l00351"></a>00351             {
<a name="l00352"></a>00352                 StringReader stringReader = <span class="keyword">new</span> StringReader(<span class="stringliteral">""</span>);
<a name="l00353"></a>00353                 <span class="keywordtype">string</span> str = pobierz();
<a name="l00354"></a>00354                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>));
<a name="l00355"></a>00355                 odpSerwera = (<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>)xml.Deserialize(<span class="keyword">new</span> StringReader(str));
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357             <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00358"></a>00358             {
<a name="l00359"></a>00359                 bo.add(<span class="stringliteral">"-- odpowiedz wgrywanie plikow"</span>);
<a name="l00360"></a>00360                 <span class="keywordflow">throw</span> bo;
<a name="l00361"></a>00361             }
<a name="l00362"></a>00362             <span class="keywordflow">catch</span> (Exception)
<a name="l00363"></a>00363             {
<a name="l00364"></a>00364                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- odpowiedz wgrywanie plikow"</span>);
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/d52/a00023.html#9e0414e76ae1f264010bd1dc1abbaef6">operacja</a> != (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.wysylanie) <span class="keywordflow">return</span> -3;
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.plik_istnieje)
<a name="l00368"></a>00368             {
<a name="l00369"></a>00369                 <span class="keywordtype">string</span> odp;
<a name="l00370"></a>00370                 <span class="keywordflow">if</span> (MessageBox.Show(<span class="stringliteral">"Plik "</span> + nazwa + <span class="stringliteral">" istnieje na serwerze, czy zastapic go?"</span>, <span class="stringliteral">""</span>, MessageBoxButtons.YesNo) == DialogResult.Yes)
<a name="l00371"></a>00371                 {
<a name="l00372"></a>00372                     odp = <span class="stringliteral">"ok"</span>;
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374                 <span class="keywordflow">else</span>
<a name="l00375"></a>00375                 {
<a name="l00376"></a>00376                     odp = <span class="stringliteral">"abort"</span>;
<a name="l00377"></a>00377                 }
<a name="l00378"></a>00378                 <span class="keywordflow">try</span>
<a name="l00379"></a>00379                 {
<a name="l00380"></a>00380                     StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00381"></a>00381                     XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>));
<a name="l00382"></a>00382                     <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a> kod = <span class="keyword">new</span> <a class="code" href="../../d7/dec/a00010.html" title="Klasa zawiera dane do serializacji odpowiedzi o ściągnięcie pliku.">klientOdpDownload</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.wysylanie, odp);
<a name="l00383"></a>00383                     xml.Serialize(stringWriter, kod, names);
<a name="l00384"></a>00384                     <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00385"></a>00385                     wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00386"></a>00386                 }
<a name="l00387"></a>00387                 <span class="keywordflow">catch</span> (Exception)
<a name="l00388"></a>00388                 {
<a name="l00389"></a>00389                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania danych na serwer. Sprawdz polaczenie z internetem, oraz ewentualnie ustaw proxy -- odpowiedz czy plik zastapic"</span>);
<a name="l00390"></a>00390                 }
<a name="l00391"></a>00391                 <span class="keywordflow">try</span>
<a name="l00392"></a>00392                 {
<a name="l00393"></a>00393                     StringReader stringReader = <span class="keyword">new</span> StringReader(<span class="stringliteral">""</span>);
<a name="l00394"></a>00394                     <span class="keywordtype">string</span> str2 = pobierz();
<a name="l00395"></a>00395                     XmlSerializer x = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>));
<a name="l00396"></a>00396                     odpSerwera = (<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>)x.Deserialize(<span class="keyword">new</span> StringReader(str2));
<a name="l00397"></a>00397                 }
<a name="l00398"></a>00398                 <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00399"></a>00399                 {
<a name="l00400"></a>00400                     bo.add(<span class="stringliteral">"-- odpowiedz na zapytanie czy zastapic"</span>);
<a name="l00401"></a>00401                     <span class="keywordflow">throw</span> bo;
<a name="l00402"></a>00402                 }
<a name="l00403"></a>00403                 <span class="keywordflow">catch</span> (Exception ex)
<a name="l00404"></a>00404                 {
<a name="l00405"></a>00405                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- odpowiedz na zapytanie czy zastapic"</span> + ex.ToString());
<a name="l00406"></a>00406                 }
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/d52/a00023.html#9e0414e76ae1f264010bd1dc1abbaef6">operacja</a> != (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.wysylanie) <span class="keywordflow">return</span> -3;
<a name="l00409"></a>00409             <span class="keywordflow">if</span> (odpSerwera.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.wszystko_ok || odpSerwera.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (int)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.plik_nie_istnieje)
<a name="l00410"></a>00410             {
<a name="l00411"></a>00411                 <span class="keywordtype">int</span> rozmiarUp = 102400;
<a name="l00412"></a>00412                 <span class="keywordtype">int</span> rozmiarTmp = rozmiar;
<a name="l00413"></a>00413                 FileStream fileStream = <span class="keyword">new</span> FileStream(katalog + nazwa, FileMode.Open, FileAccess.Read);
<a name="l00414"></a>00414                 BinaryReader br = <span class="keyword">new</span> BinaryReader(fileStream);
<a name="l00415"></a>00415                 <span class="keywordtype">int</span> c = 0;
<a name="l00416"></a>00416                 <span class="keywordflow">try</span>
<a name="l00417"></a>00417                 {
<a name="l00418"></a>00418                     <span class="keywordflow">while</span> (rozmiarTmp != 0)
<a name="l00419"></a>00419                     {
<a name="l00420"></a>00420                         c++;
<a name="l00421"></a>00421                         <span class="keywordflow">if</span> (rozmiarTmp &lt; rozmiarUp)
<a name="l00422"></a>00422                             rozmiarUp = rozmiarTmp;
<a name="l00423"></a>00423                         byte[] bytes = br.ReadBytes(rozmiarUp);
<a name="l00424"></a>00424                         wyslij(bytes, rozmiarUp);
<a name="l00425"></a>00425                         rozmiarTmp -= rozmiarUp;
<a name="l00426"></a>00426                         <a class="code" href="../../d8/d41/a00038.html#81a223a02c34d82b47199f08308847f2">System</a>.Threading.Thread.Sleep(100);
<a name="l00427"></a>00427                     }
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429                 <span class="keywordflow">catch</span> (Exception)
<a name="l00430"></a>00430                 {
<a name="l00431"></a>00431                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania pliku na serwer -- wysylanie pliku"</span>);
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433                 <span class="keywordflow">finally</span>
<a name="l00434"></a>00434                 {
<a name="l00435"></a>00435                     fileStream.Close();
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437                 fileStream.Close();
<a name="l00438"></a>00438                 <span class="keywordflow">try</span>
<a name="l00439"></a>00439                 {
<a name="l00440"></a>00440                     XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d4/dee/a00008.html" title="Klasa zawiera dane do serializacji wysyłania hasha pliku.">klientHash</a>));
<a name="l00441"></a>00441                     <a class="code" href="../../d4/dee/a00008.html" title="Klasa zawiera dane do serializacji wysyłania hasha pliku.">klientHash</a> khash = <span class="keyword">new</span> <a class="code" href="../../d4/dee/a00008.html" title="Klasa zawiera dane do serializacji wysyłania hasha pliku.">klientHash</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.wysylanie, hashPliku(katalog + nazwa));
<a name="l00442"></a>00442                     StringWriter sw = <span class="keyword">new</span> StringWriter();
<a name="l00443"></a>00443                     xml.Serialize(sw, khash, names);
<a name="l00444"></a>00444                     <span class="keywordtype">string</span> str = sw.ToString() + endl;
<a name="l00445"></a>00445                     wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00446"></a>00446                 }
<a name="l00447"></a>00447                 <span class="keywordflow">catch</span> (Exception)
<a name="l00448"></a>00448                 {
<a name="l00449"></a>00449                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas wysylania pliku na serwer -- wysylanie hasha"</span>);
<a name="l00450"></a>00450                 }
<a name="l00451"></a>00451             }
<a name="l00452"></a>00452             <span class="keywordflow">return</span> odpSerwera.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a>;
<a name="l00453"></a>00453         }
<a name="l00459"></a><a class="code" href="../../d7/dd4/a00013.html#d35eb35f48583fef5bf19cb2a0b2c9c5">00459</a>         <span class="keyword">private</span> <span class="keywordtype">string</span> hashPliku(<span class="keywordtype">string</span> plik)
<a name="l00460"></a>00460         {
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (!File.Exists(plik)) <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BrakPliku(<span class="stringliteral">"Brak pliku "</span> + plik);
<a name="l00462"></a>00462             StringBuilder sb = <span class="keyword">new</span> StringBuilder();
<a name="l00463"></a>00463             FileStream fs = <span class="keyword">new</span> FileStream(plik, FileMode.Open);
<a name="l00464"></a>00464             MD5 md5 = <span class="keyword">new</span> MD5CryptoServiceProvider();
<a name="l00465"></a>00465             byte[] hash = md5.ComputeHash(fs);
<a name="l00466"></a>00466             fs.Close();
<a name="l00467"></a>00467             <span class="keywordflow">foreach</span> (byte hex <span class="keywordflow">in</span> hash)
<a name="l00468"></a>00468                 sb.Append(hex.ToString(<span class="stringliteral">"x2"</span>));
<a name="l00469"></a>00469             <span class="keywordflow">return</span> sb.ToString();
<a name="l00470"></a>00470         }
<a name="l00476"></a><a class="code" href="../../d7/dd4/a00013.html#9ca2f36e9df9288ff32c44e789b0e576">00476</a>         <span class="keyword">public</span> List&lt;plikInfo&gt; downloadListy(<span class="keywordtype">string</span> uzytkownik)
<a name="l00477"></a>00477         {
<a name="l00478"></a>00478             <span class="keywordflow">if</span> (uzytkownik.Length == 0) uzytkownik = <span class="stringliteral">"."</span>;
<a name="l00479"></a>00479             <span class="keywordflow">try</span>
<a name="l00480"></a>00480             {
<a name="l00481"></a>00481                 <a class="code" href="../../dd/d1b/a00015.html" title="Klasa zawiera dane do serializacji listy plikow uzytkownika.">listaPlikow</a> lista = <span class="keyword">new</span> <a class="code" href="../../dd/d1b/a00015.html" title="Klasa zawiera dane do serializacji listy plikow uzytkownika.">listaPlikow</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.lista, uzytkownik);
<a name="l00482"></a>00482                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../dd/d1b/a00015.html" title="Klasa zawiera dane do serializacji listy plikow uzytkownika.">listaPlikow</a>));
<a name="l00483"></a>00483                 StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00484"></a>00484                 xml.Serialize(stringWriter, lista, names);
<a name="l00485"></a>00485                 <span class="keywordtype">string</span> str = stringWriter.ToString() + endl;
<a name="l00486"></a>00486                 wyslij(ASCIIEncoding.ASCII.GetBytes(str), str.Length);
<a name="l00487"></a>00487             }
<a name="l00488"></a>00488             <span class="keywordflow">catch</span> (Exception)
<a name="l00489"></a>00489             {
<a name="l00490"></a>00490                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas pobierania listy plikow -- zapytanie o download"</span>);
<a name="l00491"></a>00491             }
<a name="l00492"></a>00492             <a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a> <a class="code" href="../../d4/d51/a00017.html" title="Klasa zawiera liste plikow z ich informacjami.">pliki</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>();
<a name="l00493"></a>00493             <span class="keywordflow">try</span>
<a name="l00494"></a>00494             {
<a name="l00495"></a>00495                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>));
<a name="l00496"></a>00496                 StringReader stringReader = <span class="keyword">new</span> StringReader(<span class="stringliteral">""</span>);
<a name="l00497"></a>00497                 <span class="keywordtype">string</span> str = pobierz();
<a name="l00498"></a>00498                 pliki = (<a class="code" href="../../d6/d5b/a00026.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera na zapytanie o liste plikow...">serwerPliki</a>)xml.Deserialize(<span class="keyword">new</span> StringReader(str));
<a name="l00499"></a>00499             }
<a name="l00500"></a>00500             <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00501"></a>00501             {
<a name="l00502"></a>00502                 bo.add(<span class="stringliteral">"-- odpowiedz na pobranie listy"</span>);
<a name="l00503"></a>00503                 <span class="keywordflow">throw</span> bo;
<a name="l00504"></a>00504             }
<a name="l00505"></a>00505             <span class="keywordflow">catch</span> (Exception)
<a name="l00506"></a>00506             {
<a name="l00507"></a>00507                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- odpowiedz na pobranie listy"</span>);
<a name="l00508"></a>00508             }
<a name="l00509"></a>00509             <span class="keywordflow">if</span> (pliki.<a class="code" href="../../d3/d52/a00023.html#9e0414e76ae1f264010bd1dc1abbaef6">operacja</a> != (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.lista) <span class="keywordflow">return</span> null;
<a name="l00510"></a>00510             <span class="keywordflow">if</span> (pliki.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> != (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.wszystko_ok) <span class="keywordflow">return</span> null;
<a name="l00511"></a>00511             <span class="keywordflow">return</span> pliki.<a class="code" href="../../d6/d5b/a00026.html#b6d1b334712037271b25777240056f83">plik</a>;
<a name="l00512"></a>00512         }
<a name="l00518"></a><a class="code" href="../../d7/dd4/a00013.html#302b89f984b2f9c695f1ae9462414d84">00518</a>         <span class="keyword">public</span> <span class="keywordtype">int</span> usunPliki(List&lt;pojedynczyPlik&gt; plikiDoUsuniecia)
<a name="l00519"></a>00519         {
<a name="l00520"></a>00520             List&lt;plikInfo&gt; plikiDoUs = <span class="keyword">new</span> List&lt;plikInfo&gt;();
<a name="l00521"></a>00521             <span class="keywordflow">foreach</span> (<a class="code" href="../../db/db2/a00020.html" title="Klasa zawiera dane o pliku.">pojedynczyPlik</a> p <span class="keywordflow">in</span> plikiDoUsuniecia)
<a name="l00522"></a>00522                 plikiDoUs.Add(<span class="keyword">new</span> <a class="code" href="../../d1/d2b/a00018.html" title="Klasa zawiera dane do serializacji rozszerzonych informacji o pliku.">plikInfo</a>(p.<a class="code" href="../../db/db2/a00020.html#f792807be9c86aacf7306b9365c2436e">nazwa</a>, -1, -1, -1, p.<a class="code" href="../../db/db2/a00020.html#e211a903ec9f14ec1e4cc1652ce6ce54">hash</a>));
<a name="l00523"></a>00523             <span class="keywordflow">try</span>
<a name="l00524"></a>00524             {
<a name="l00525"></a>00525                 <a class="code" href="../../df/d86/a00012.html" title="Klasa zawiera dane do serializacji zapytania o usunięcie pliku.">klientUsun</a> usun = <span class="keyword">new</span> <a class="code" href="../../df/d86/a00012.html" title="Klasa zawiera dane do serializacji zapytania o usunięcie pliku.">klientUsun</a>(sessionID, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#bdaf61f2216998b5bed708a9013fcaa2" title="Typ numeryczny reprezentuje wszystkie akcje dostepne w komunikacji z serwerem.">operacje</a>.usuwanie, plikiDoUs);
<a name="l00526"></a>00526                 XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../df/d86/a00012.html" title="Klasa zawiera dane do serializacji zapytania o usunięcie pliku.">klientUsun</a>));
<a name="l00527"></a>00527                 StringWriter stringWriter = <span class="keyword">new</span> StringWriter();
<a name="l00528"></a>00528                 xml.Serialize(stringWriter, usun, names);
<a name="l00529"></a>00529                 <span class="keywordtype">string</span> strToWrite = stringWriter.ToString() + endl;
<a name="l00530"></a>00530                 wyslij(ASCIIEncoding.ASCII.GetBytes(strToWrite), strToWrite.Length);
<a name="l00531"></a>00531             }
<a name="l00532"></a>00532             <span class="keywordflow">catch</span> (Exception ex)
<a name="l00533"></a>00533             {
<a name="l00534"></a>00534                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladWysylania(<span class="stringliteral">"Blad podczas usuwania plików z serwera -- usuwanie zapytanie"</span>);
<a name="l00535"></a>00535             }
<a name="l00536"></a>00536             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; plikiDoUsuniecia.Count; j++)
<a name="l00537"></a>00537             {
<a name="l00538"></a>00538                 <a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a> odpSerw = <span class="keyword">new</span> <a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>();
<a name="l00539"></a>00539                 <span class="keywordflow">try</span>
<a name="l00540"></a>00540                 {
<a name="l00541"></a>00541                     XmlSerializer xml = <span class="keyword">new</span> XmlSerializer(typeof(<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>));
<a name="l00542"></a>00542                     <span class="keywordtype">string</span> str = pobierz();
<a name="l00543"></a>00543                     odpSerw = (<a class="code" href="../../d3/d52/a00023.html" title="Klasa zawiera dane do serializacji odpowiedzi serwera.">serwerBase</a>)xml.Deserialize(<span class="keyword">new</span> StringReader(str));
<a name="l00544"></a>00544                 }
<a name="l00545"></a>00545                 <span class="keywordflow">catch</span> (<a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladOdbierania bo)
<a name="l00546"></a>00546                 {
<a name="l00547"></a>00547                     bo.add(<span class="stringliteral">"-- usuwanie odpowiedz"</span>);
<a name="l00548"></a>00548                     <span class="keywordflow">throw</span> bo;
<a name="l00549"></a>00549                 }
<a name="l00550"></a>00550                 <span class="keywordflow">catch</span> (Exception)
<a name="l00551"></a>00551                 {
<a name="l00552"></a>00552                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../d5/d79/a00030.html">Wyjatki</a>.BladParsowania(<span class="stringliteral">"Dostano bledne dane od serwera lub nastapil blad programu -- usuwanie odpowiedz"</span>);
<a name="l00553"></a>00553                 }
<a name="l00554"></a>00554                 <span class="keywordflow">if</span> (odpSerw.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.blad_serwera || odpSerw.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a> == (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dd4/a00013.html#269bf72dbaab617daf62394689014af9" title="Typ reprezentuje możliwe odpowiedzi serwera.">odpowiedzi</a>.bledny_numer_sesji) <span class="keywordflow">return</span> odpSerw.<a class="code" href="../../d3/d52/a00023.html#536a1e136873a8bc73f912bb72ee154a">odp</a>;
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556             <span class="keywordflow">return</span> 1;
<a name="l00557"></a>00557         }
<a name="l00561"></a>00561         <span class="keyword">public</span> <span class="keywordtype">string</span> Login
<a name="l00562"></a><a class="code" href="../../d7/dd4/a00013.html#2c321eee82dba3f82cae18a5b4d6d620">00562</a>         {
<a name="l00563"></a>00563             <span class="keyword">get</span>
<a name="l00564"></a>00564             {
<a name="l00565"></a>00565                 <span class="keywordflow">return</span> log;
<a name="l00566"></a>00566             }
<a name="l00567"></a>00567             <span class="keyword">set</span>
<a name="l00568"></a>00568             {
<a name="l00569"></a>00569                 log = value;
<a name="l00570"></a>00570             }
<a name="l00571"></a>00571         }
<a name="l00575"></a>00575         <span class="keyword">public</span> <span class="keywordtype">string</span> Serwer
<a name="l00576"></a><a class="code" href="../../d7/dd4/a00013.html#d9eb3fc56fa999cc46116e3d7019f070">00576</a>         {
<a name="l00577"></a>00577             <span class="keyword">get</span>
<a name="l00578"></a>00578             {
<a name="l00579"></a>00579                 <span class="keywordflow">return</span> serverIP;
<a name="l00580"></a>00580             }
<a name="l00581"></a>00581         }
<a name="l00585"></a>00585         <span class="keyword">public</span> <span class="keywordtype">int</span> Port
<a name="l00586"></a><a class="code" href="../../d7/dd4/a00013.html#90c9595c1609fb8364d7e2a8d806a27c">00586</a>         {
<a name="l00587"></a>00587             <span class="keyword">get</span>
<a name="l00588"></a>00588             {
<a name="l00589"></a>00589                 <span class="keywordflow">return</span> serverPort;
<a name="l00590"></a>00590             }
<a name="l00591"></a>00591         }
<a name="l00595"></a>00595         <span class="keyword">public</span> <span class="keywordtype">string</span> Haslo
<a name="l00596"></a><a class="code" href="../../d7/dd4/a00013.html#3c5917b1f8a0fb187d3c48ff22b25ec6">00596</a>         {
<a name="l00597"></a>00597             <span class="keyword">set</span>
<a name="l00598"></a>00598             {
<a name="l00599"></a>00599                 haslo = value;
<a name="l00600"></a>00600             }
<a name="l00601"></a>00601             <span class="keyword">get</span>
<a name="l00602"></a>00602             {
<a name="l00603"></a>00603                 <span class="keywordflow">return</span> haslo;
<a name="l00604"></a>00604             }
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Wygenerowano Thu Jun 4 19:42:01 2009 dla Ass8-Klient programem&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
